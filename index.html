<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenMCT Cesium Plugin - Test Harness</title>
    <link rel="stylesheet" href="/snowTheme.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #openmct {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="openmct"></div>

    <script type="module">
        import * as openmctModule from 'openmct';
        import CesiumPlugin from './src/index.js';

        // Wait for DOM and CSS to be ready
        window.addEventListener('load', () => {
            // Add required OpenMCT class before initialization
            document.body.classList.add('user-helper');

            // Get OpenMCT instance - it can be a constructor OR a pre-instantiated object
            let app;

            // Check if default export is a constructor function
            if (typeof openmctModule.default === 'function') {
                try {
                    app = openmctModule.default();
                } catch (e) {
                    console.error('Failed to call default constructor:', e);
                    return;
                }
            }
            // Check if default export is already an instance (has OpenMCT methods)
            else if (openmctModule.default && typeof openmctModule.default.install === 'function') {
                app = openmctModule.default;
            }
            // Check if the module itself is a constructor
            else if (typeof openmctModule === 'function') {
                try {
                    app = openmctModule();
                } catch (e) {
                    console.error('Failed to call module as constructor:', e);
                    return;
                }
            }
            // Maybe it's a global
            else if (typeof window.openmct === 'function') {
                app = window.openmct();
            }
            else {
                console.error('Could not find OpenMCT constructor or instance', openmctModule);
                return;
            }

            // Set asset path for OpenMCT icons and resources
            app.setAssetPath('/node_modules/openmct/dist');

            // Install default plugins that OpenMCT needs
            app.install(app.plugins.LocalStorage());
            app.install(app.plugins.MyItems());
            app.install(app.plugins.UTCTimeSystem());

            // Install the Cesium plugin
            app.install(CesiumPlugin());

            // Set up time conductor after plugins are installed
            app.time.setClock('local');
            const now = Date.now();
            app.time.setTimeSystem('utc', {
                start: now - 900000,  // 15 minutes ago
                end: now
            });

            // Create test satellite objects
            const testSatellite1 = {
                identifier: {
                    namespace: 'test',
                    key: 'satellite-1'
                },
                name: 'ISS',
                type: 'satellite'
            };

            // Create a simple root object for testing
            const rootObject = {
                identifier: {
                    namespace: 'test',
                    key: 'root'
                },
                name: 'Test Root',
                type: 'folder',
                composition: [
                    testSatellite1.identifier
                ]
            };

            // Add a test object provider
            app.objects.addProvider('test', {
                get(identifier) {
                    if (identifier.key === 'root') {
                        return Promise.resolve(rootObject);
                    }
                    if (identifier.key === 'satellite-1') {
                        return Promise.resolve(testSatellite1);
                    }
                    // Return a generic test satellite object for any other request
                    return Promise.resolve({
                        identifier: identifier,
                        name: 'Test Satellite',
                        type: 'satellite'
                    });
                }
            });

            // Add root to tree
            app.objects.addRoot(rootObject.identifier);

            // Start OpenMCT
            try {
                app.start(document.getElementById('openmct'));
                console.log('OpenMCT started successfully with Cesium plugin');
            } catch (e) {
                console.error('Failed to start OpenMCT:', e);
            }
        });
    </script>
</body>
</html>
