<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open MCT Cesium - Unified Test Harness</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/snowTheme.css">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
        #openmct { width: 100%; height: 100%; }
    </style>
</head>
<body class="user-helper">
    <div id="openmct"></div>

    <script type="module">
        import openmct from 'openmct';
        import CesiumPlugin from './src/plugin/CesiumPlugin.js';

        // 1. Set Asset Path - Required for Workers to load correctly
        openmct.setAssetPath('/');

        // 2. Install Essential Plugins
        openmct.install(openmct.plugins.LocalStorage());
        openmct.install(openmct.plugins.MyItems());
        openmct.install(openmct.plugins.UTCTimeSystem());
        
        openmct.install(openmct.plugins.Conductor({
            menuOptions: [
                {
                    name: "Fixed",
                    timeSystem: "utc",
                    bounds: { start: Date.now() - 900000, end: Date.now() }
                },
                {
                    name: "Realtime",
                    timeSystem: "utc",
                    clock: "local",
                    clockOffsets: { start: -900000, end: 30000 }
                }
            ]
        }));

        // 3. Install the Cesium Plugin
        openmct.install(CesiumPlugin());

        // 4. Fully Defined Satellite Object (fixes the addEventListener crash)
        const satelliteMetadata = {
            values: [
                { key: 'utc', name: 'Time', format: 'utc', hints: { domain: 1 } },
                { key: 'position.latitude', name: 'Lat', format: 'float', units: 'deg', hints: { range: 1 } },
                { key: 'position.longitude', name: 'Lon', format: 'float', units: 'deg', hints: { range: 2 } },
                { key: 'position.altitude', name: 'Alt', format: 'float', units: 'm', hints: { range: 3 } }
            ]
        };

        const satelliteObject = {
            identifier: { namespace: 'test', key: 'sat-1' },
            name: 'ISS (Mock)',
            type: 'satellite',
            telemetry: satelliteMetadata,
            location: 'test:root'
        };

        const globeObject = {
            identifier: { namespace: 'test', key: 'globe-1' },
            name: 'Master Earth View',
            type: 'cesium.globe',
            composition: [ { namespace: 'test', key: 'sat-1' } ],
            location: 'test:root'
        };

        const rootObject = {
            identifier: { namespace: 'test', key: 'root' },
            name: 'Mission Overview',
            type: 'folder',
            composition: [ 
                { namespace: 'test', key: 'globe-1' },
                { namespace: 'test', key: 'sat-1' }
            ],
            location: 'ROOT'
        };

        // 5. Mock Telemetry Provider
        openmct.telemetry.addProvider({
            supportsSubscribe: (domainObject) => domainObject.type === 'satellite',
            supportsRequest: (domainObject) => domainObject.type === 'satellite',
            subscribe: (domainObject, callback) => {
                const interval = setInterval(() => {
                    const now = Date.now();
                    callback({
                        utc: now,
                        'position.latitude': Math.sin(now / 10000) * 45,
                        'position.longitude': (now / 500) % 360 - 180,
                        'position.altitude': 400000
                    });
                }, 1000);
                return () => clearInterval(interval);
            },
            request: async (domainObject, options) => {
                let data = [];
                for (let t = options.start; t < options.end; t += 10000) {
                    data.push({
                        utc: t,
                        'position.latitude': Math.sin(t / 10000) * 45,
                        'position.longitude': (t / 500) % 360 - 180,
                        'position.altitude': 400000
                    });
                }
                return data;
            }
        });

        // 6. Object Provider
        openmct.objects.addProvider('test', {
            get: (identifier) => {
                if (identifier.key === 'root') return Promise.resolve(rootObject);
                if (identifier.key === 'globe-1') return Promise.resolve(globeObject);
                if (identifier.key === 'sat-1') return Promise.resolve(satelliteObject);
                return Promise.reject(new Error("Object not found"));
            }
        });

        openmct.objects.addRoot({ namespace: 'test', key: 'root' });

        openmct.start();
    </script>
</body>
</html>